<!DOCTYPE HTML>

<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta charset="utf-8">

    <!-- Description, Keywords and Author -->

    <meta name="description" content="">
    <meta name="author" content="">
    <title>Hibernate 自定义查询sql 并使用自定义对象接收查询结果</title>
    <link rel="shortcut icon" href="http://img.winterchen.com/favicon.ico" type="image/x-icon">

    <meta name="google-site-verification" content="eSQZAmjfibuJ-t-hspvmzqj-n0-YmQI-uVfeHZG3Yw8" />
    <meta name="baidu-site-verification" content="cWhqikcyTK" />
    <!-- style -->

    <link href="../../site/css/style.css" rel="stylesheet" type="text/css">
    <link href="../../site/css/style.min.css" rel="stylesheet" type="text/css">
    <link href="https://cdn.bootcss.com/highlight.js/9.9.0/styles/xcode.min.css" rel="stylesheet"/>

    <!-- style -->

    <!-- bootstrap -->

    <link href="../../site/css/bootstrap.min.css" rel="stylesheet" type="text/css">

    <!-- responsive -->

    <link href="../../site/css/responsive.css" rel="stylesheet" type="text/css">

    <!-- font-awesome -->

    <link rel="stylesheet" type="text/css" href="../../site/jquery/font-awesome.4.6.0.css">

    <!-- font-awesome -->

    <link href="../../site/css/effects/set2.css" rel="stylesheet" type="text/css">
    <link href="../../site/css/effects/normalize.css" rel="stylesheet" type="text/css">
    <link href="../../site/css/effects/component.css"  rel="stylesheet" type="text/css" >
</head>


<body>


<!-- header -->

<html lang="en">
<header role="header">
    <div class="container">

        <!-- logo -->

        <h1> <a href="../../index.html" title="avana LLC"><img src="http://img.winterchen.com/BF6AC5E5-C8D7-4841-B3ED-9D898586D5FF-9703-0000073B1BF8A7F8_tmp.PNG" style="width: 66px;" title="avana LLC" alt="avana LLC"/></a> </h1>

        <!-- logo -->

        <!-- nav -->

        <nav role="header-nav" class="navy">
            <ul>
                <li><a href="../../index.html" title="Work">Work</a></li>
                <li><a  href="../../about.html" title="About">About</a></li>
                <li class="nav-active"><a href="../index.html" title="Blog">Blog</a></li>
            </ul>
        </nav>

        <!-- nav -->

    </div>
</header>
</html>

<!-- header -->

<!-- main -->

<main role="main-inner-wrapper" class="container">


    <div class="blog-details">

        <article class="post-details" id="post-details">

            <header role="bog-header" class="bog-header text-center">

                <h3>
                    <span>12</span> 五月  2018
                </h3>

                <h2>
                    Hibernate 自定义查询sql 并使用自定义对象接收查询结果
                </h2>

            </header>


            <figure>

                <img src="https://luischen.cn/blog/article/images/blog-images/blog-details-image.jpg" alt="" class="img-responsive"/>

            </figure>

            <div id="post-content" class="post-content" itemprop="articleBody">
                <p><img src="http://img.winterchen.com/alex-6723-unsplash.jpg" alt="" /></p>
<blockquote>
<p>在很多的生产中，hibernate并不能满足我们所有的开发需求，比如，很多表的联合查询，并且查询之后的各种结果封装在自定义的dto对象中，那么我们就需要使用自定义的sql进行查询了，好了，开始我们新的旅程吧。</p>
</blockquote>
<!--  more  -->
<blockquote>
<h3>需求：</h3>
<ul>
<li>n张表进行联合查询</li>
</ul>
<blockquote>
<ul>
<li>将结果封装在一个DTO的对象中</li>
</ul>
</blockquote>
</blockquote>
<h3>代码：</h3>
<p><strong>本文中使用了一个很复杂的联合查询的sql，所以大家并不需要了解详细，只需要只是我们进行一个很复杂的多张表进行联合查询的操作，最后将结果使用自定义的dto对象接收即可</strong></p>
<h4>SQL</h4>
<pre><code class="language-sql">SELECT
    p9.projectId,
    p9.fenxiaoMoney,
    p9.shopCount
FROM
    (
        SELECT
            p8.projectId,
            p8.fenxiaoMoney,
            count(ic.inviteByPerson) shopCount
        FROM
        (
            SELECT
                p7.projectId,
                p7.fenxiaoMoney
            FROM
                (
                    SELECT
                        pp.projectId,
                        g.fenxiaoMoney
                    FROM
                        (
                            SELECT
                                p6.projectId
                            FROM
                                (
                                    SELECT
                                        p5.projectId
                                    FROM
                                        (
                                            SELECT
                                                p4.projectId
                                            FROM
                                                (
                                                    SELECT
                                                        p2.projectId
                                                    FROM
                                                        (
                                                            SELECT
                                                                p1.projectId
                                                            FROM
                                                                (
                                                                    SELECT
                                                                        p.projectId
                                                                    FROM
                                                                        t_projects p
                                                                    WHERE
                                                                        1 = 1
                                                                    AND p.averagePrice &gt;= 1.0
                                                                    AND p.averagePrice &lt;= 10000000000.0
                                                                    AND p.saleLongitude &gt;= 1.0
                                                                    AND p.saleLongitude &lt;= 10000.00
                                                                    AND p.saleLatitude &gt;= 1.0
                                                                    AND p.saleLatitude &lt;= 10000.0
                                                                    AND p.rightsYears = 70
                                                                    AND p.city LIKE '%330000%' #AND p.isOpenStatus = 1
                                                                    AND p.buildArea &gt;= 1.0
                                                                    AND p.buildArea &lt;= 10000000.0 #AND p.afforestationRatio = 1
                                                                    AND p.projectName LIKE '%%' #AND p.projectId = '1515269bc87448b4927fa676c624c8f6'
                                                                ) p1
                                                            INNER JOIN (
                                                                SELECT
                                                                    targetId
                                                                FROM
                                                                    t_tagsrelation
                                                                WHERE
                                                                    1 = 1
                                                                AND originalTags LIKE '%4507%'
                                                                AND originalTags LIKE '%757%'
                                                            ) t1 ON p1.projectId = t1.targetId
                                                        ) p2
                                                    INNER JOIN (
                                                        SELECT
                                                            h.projectId
                                                        FROM
                                                            t_projecthouses h
                                                        WHERE
                                                            h.houseNum IN (
                                                                SELECT
                                                                    targetId
                                                                FROM
                                                                    t_tagsrelation
                                                                WHERE
                                                                    1 = 1
                                                                AND originalTags LIKE '%%'
                                                            )
                                                        AND h.houseStatus = 1
                                                        AND isOpen = 1
                                                    ) p3 ON p2.projectId = p3.projectId
                                                ) p4
                                            INNER JOIN (
                                                SELECT
                                                    projectId
                                                FROM
                                                    t_projecthousetypes pht
                                                WHERE
                                                    1 = 1
                                                AND pht.housType = '三房两厅一卫'
                                            ) pht1 ON p4.projectId = pht1.projectId
                                            GROUP BY
                                                p4.projectId
                                        ) p5
                                    INNER JOIN (
                                        SELECT
                                            ph.projectId
                                        FROM
                                            t_projecthouses ph
                                        WHERE
                                            1 = 1
                                        AND (
                                            ph.houseKind = '10'
                                            OR ph.houseKind = '0'
                                        )
                                    ) hk ON p5.projectId = hk.projectId
                                    GROUP BY
                                        p5.projectId
                                ) p6
                            INNER JOIN (
                                SELECT
                                    applyForPerson
                                FROM
                                    t_applychart
                                WHERE
                                    applyByPerson = '860635'
                                AND applyStatus = 2
                            ) ap ON p6.projectId = ap.applyForPerson
                        ) pp
                    LEFT JOIN t_projectguide g ON pp.projectId = g.projectId
                ) p7
        ) p8

        LEFT JOIN (SELECT inviteByPerson FROM t_invitechart WHERE inviteStatus = 2) ic ON p8.projectId = ic.inviteByPerson
        GROUP BY
            p8.projectId
    ) p9
LEFT JOIN (
    SELECT
        beCollectId
    FROM
        t_newcollectrecord
    WHERE
        userId = '4e0b0089-410a-497e-8056-6190e2a183d4'
) nc ON p9.projectId = nc.beCollectId
GROUP BY
    p9.projectId
ORDER BY
    shopCount DESC
LIMIT 0,
 10
</code></pre>
<p>从sql中可以看出我们需要查的三个参数：</p>
<ul>
<li>项目的Id</li>
<li>钱的数量</li>
<li>合作店铺的数量</li>
</ul>
<p>需要的额外功能：</p>
<ul>
<li>分页</li>
<li>根据上面的参数进行排序</li>
</ul>
<h4>SQL拼接方法</h4>
<p><strong>顾名思义就是将上述的sql使用java进行拼接，因为这样便于查看和bug查找(这段并不重要)</strong></p>
<pre><code class="language-java">/**
     * 拼接Hql中的p段
     * @param param
     * @param user
     * @param sb
     */
    private void jointHqlTheP(ShopSearchParam param, User user, StringBuilder sb){
        /**
         * SELECT
                p.projectId
            FROM
                t_projects p
            WHERE
                1 = 1
            AND p.averagePrice &gt;= 1.0
            AND p.averagePrice &lt;= 10000000000.0
            AND p.saleLongitude &gt;= 1.0
            AND p.saleLongitude &lt;= 10000.00
            AND p.saleLatitude &gt;= 1.0
            AND p.saleLatitude &lt;= 10000.0
            AND p.rightsYears = 70
            AND p.city LIKE '%330000%' #AND p.isOpenStatus = 1
            AND p.buildArea &gt;= 1.0
            AND p.buildArea &lt;= 10000000.0 #AND p.afforestationRatio = 1
            AND p.projectName LIKE '%%' #AND p.projectId = '1515269bc87448b4927fa676c624c8f6'
         */

        sb.append(&quot; SELECT &quot;);
        sb.append(&quot; p.projectId &quot;);
        sb.append(&quot; FROM &quot;);
        sb.append(&quot; t_projects p &quot;);
        sb.append(&quot; WHERE &quot;);
        sb.append(&quot; 1 = 1 &quot;);
        if(param.getMinAveragePrice() != null){
            sb.append(&quot; AND p.averagePrice &gt;= &quot; + param.getMinAveragePrice());
        }
        if(param.getMaxAveragePrice() != null){
            sb.append(&quot; AND p.averagePrice &lt;= &quot; + param.getMaxAveragePrice());
        }
        if(!isEmpty(param.getMinLongitudes())){
            sb.append(&quot; AND p.saleLongitude &gt;= &quot; + param.getMinLongitudes());
        }
        if(!isEmpty(param.getMaxLongitudes())){
            sb.append(&quot; AND p.saleLongitude &lt;= &quot; + param.getMaxLongitudes());
        }
        if(!isEmpty(param.getMinLatitudes())){
            sb.append(&quot; AND p.saleLatitude &gt;= &quot; + param.getMinLatitudes());
        }
        if(!isEmpty(param.getMaxLatitudes())){
            sb.append(&quot; AND p.saleLatitude &lt;= &quot; + param.getMaxLatitudes());
        }
        if(param.getRightsYears() != null){
            sb.append(&quot; AND p.rightsYears = &quot; + param.getRightsYears());
        }
        if(!isEmpty(param.getCityId())){
            sb.append(&quot; AND p.city LIKE '%&quot; + param.getCityId() + &quot;%'&quot;);
        }else if(!isEmpty(param.getCityName())){
            String hql = &quot;from CountryProvinceInfo where cityName = '&quot; + param.getCityName() + &quot;' and cityLevel = '市' &quot;;
            CountryProvinceInfo cp = (CountryProvinceInfo) baseDao.loadObject(hql);
            String cityId = cp.getUpCityId();
            sb.append(&quot; AND p.city LIKE '%&quot; + cityId + &quot;%'&quot;);
        }
        //项目状态 在售、等待售、全部
        if(param.getProjectStatus() != null){

            sb.append(&quot; AND p.isOpenStatus = &quot; + param.getProjectStatus());
        }
        if(param.getMinBulidArea() != null){
            sb.append(&quot; AND p.buildArea &gt;= &quot; + param.getMinBulidArea());
        }
        if(param.getMaxBuildArea() != null){
            sb.append(&quot; AND p.buildArea &lt;= &quot; + param.getMaxBuildArea());
        }
        if(!isEmpty(param.getProjectName())){
            sb.append(&quot; AND p.projectName LIKE '%&quot; + param.getProjectName() + &quot;%' &quot;);
        }
        if(!isEmpty(param.getProjectId())){
            sb.append(&quot; AND p.projectId = '&quot; + param.getProjectId() + &quot;' &quot;);
        }

    }

    /**
     * 拼接Hql的p1段 -- 项目标签过滤
     * @param param
     * @param user
     * @param sb
     */
    private void jointHqlTheP1(ShopSearchParam param, User user, StringBuilder sb){
        /**
         * SELECT
                p1.projectId
            FROM
                (
                    {p}//这个是p段
                ) p1
            INNER JOIN (
                SELECT
                    targetId
                FROM
                    t_tagsrelation
                WHERE
                    1 = 1
                AND originalTags LIKE '%4507%'
                AND originalTags LIKE '%757%'
            ) t1 ON p1.projectId = t1.targetId
         */
        sb.append(&quot; SELECT &quot;);
        sb.append(&quot; p1.projectId &quot;);
        sb.append(&quot; FROM &quot;);
        sb.append(&quot; ( &quot;);

        this.jointHqlTheP(param, user, sb);//将p加入

        sb.append(&quot; ) p1 &quot;);
        if(!isEmpty(param.getpTags())){
            sb.append(&quot; INNER JOIN ( &quot;);
            sb.append(&quot; SELECT &quot;);
            sb.append(&quot; targetId &quot;);
            sb.append(&quot; FROM &quot;);
            sb.append(&quot; t_tagsrelation &quot;);
            sb.append(&quot; WHERE &quot;);
            sb.append(&quot; 1 = 1 &quot;);
            String[] pTags = this.stringToArray(param.getpTags());
            for (int i = 0; i &lt; pTags.length; i++) {
                sb.append(&quot; AND originalTags LIKE '%&quot; + pTags[i] + &quot;%' &quot;);
            }
            sb.append(&quot; ) t1 ON p1.projectId = t1.targetId &quot;);
        }

    }

    /**
     * 拼接Hql的p2段 -- 房源标签过滤
     * @param param
     * @param user
     * @param sb
     */
    private void jointHqlTheP2(ShopSearchParam param, User user, StringBuilder sb){
        /**
         * SELECT
                p2.projectId
            FROM
                (
                    {p1}//这个是p1段
                ) p2
            INNER JOIN (
                SELECT
                    h.projectId
                FROM
                    t_projecthouses h
                WHERE
                    h.houseNum IN (
                        SELECT
                            targetId
                        FROM
                            t_tagsrelation
                        WHERE
                            1 = 1
                        AND originalTags LIKE '%%'
                    )
                AND h.houseStatus = 1
                AND isOpen = 1
            ) p3 ON p2.projectId = p3.projectId
         */

        sb.append(&quot; SELECT &quot;);
        sb.append(&quot; p2.projectId &quot;);
        sb.append(&quot; FROM &quot;);
        sb.append(&quot; ( &quot;);

        this.jointHqlTheP1(param, user, sb);//这个拼接p1

        sb.append(&quot; ) p2 &quot;);

        if(!isEmpty(param.gethTags())){
            sb.append(&quot; INNER JOIN ( &quot;);
            sb.append(&quot; SELECT &quot;);
            sb.append(&quot; h.projectId &quot;);
            sb.append(&quot; FROM &quot;);
            sb.append(&quot; t_projecthouses h &quot;);
            sb.append(&quot; WHERE &quot;);
            sb.append(&quot; h.houseNum IN ( &quot;);
            sb.append(&quot; SELECT &quot;);
            sb.append(&quot; targetId &quot;);
            sb.append(&quot; FROM &quot;);
            sb.append(&quot; t_tagsrelation &quot;);
            sb.append(&quot; WHERE &quot;);
            sb.append(&quot; 1=1 &quot;);
            String[] hTags = this.stringToArray(param.gethTags());
            for (int i = 0; i &lt; hTags.length; i++) {
                sb.append(&quot; AND originalTags LIKE '%&quot; + hTags[i] + &quot;%' &quot;);
            }
            sb.append(&quot; ) &quot;);
            sb.append(&quot; AND h.houseStatus = 1 &quot;);
            sb.append(&quot; AND isOpen = 1 &quot;);
            sb.append(&quot; ) p3 ON p2.projectId = p3.projectId &quot;);

        }
    }

    /**
     * 拼接Hql的p4段 -- 房源户型
     * @param param
     * @param user
     * @param sb
     */
    private void jointHqlTheP4(ShopSearchParam param, User user, StringBuilder sb){
        /**
         * SELECT
                p4.projectId
            FROM
                (
                    {p2}//这个是p2段
                ) p4
            INNER JOIN (
                SELECT
                    projectId
                FROM
                    t_projecthousetypes pht
                WHERE
                    1 = 1
                AND pht.housType = '三房两厅一卫'
            ) pht1 ON p4.projectId = pht1.projectId
            GROUP BY
                p4.projectId
         */
        sb.append(&quot; SELECT &quot;);
        sb.append(&quot; p4.projectId &quot;);
        sb.append(&quot; FROM &quot;);
        sb.append(&quot; ( &quot;);

        this.jointHqlTheP2(param, user, sb);

        sb.append(&quot; ) p4 &quot;);

        if(!isEmpty(param.getHouseType())){
            sb.append(&quot; INNER JOIN ( &quot;);
            sb.append(&quot; SELECT &quot;);
            sb.append(&quot; projectId &quot;);
            sb.append(&quot; FROM &quot;);
            sb.append(&quot; t_projecthousetypes pht &quot;);
            sb.append(&quot; WHERE &quot;);
            sb.append(&quot; 1 = 1 &quot;);
            sb.append(&quot; AND pht.housType = '&quot; + param.getHouseType() + &quot;' &quot;);
            sb.append(&quot; ) pht1 ON p4.projectId = pht1.projectId &quot;);
            sb.append(&quot; GROUP BY &quot;);
            sb.append(&quot; p4.projectId &quot;);
        }



    }

    /**
     * 拼接Hql的p5段 -- 房源类型过滤
     * @param param
     * @param user
     * @param sb
     */
    private void jointHqlTheP5(ShopSearchParam param, User user, StringBuilder sb){
        /**
         * SELECT
                p5.projectId
            FROM
                (
                    {p4}//拼接p4段
                ) p5
            INNER JOIN (
                SELECT
                    ph.projectId
                FROM
                    t_projecthouses ph
                WHERE
                    1 = 1
                AND (
                    ph.houseKind = '10'
                    OR ph.houseKind = '0'
                )
            ) hk ON p5.projectId = hk.projectId
            GROUP BY
                p5.projectId
         */
        sb.append(&quot; SELECT &quot;);
        sb.append(&quot; p5.projectId &quot;);
        sb.append(&quot; FROM &quot;);
        sb.append(&quot; ( &quot;);

        this.jointHqlTheP4(param, user, sb);

        sb.append(&quot; ) p5 &quot;);

        if(!isEmpty(param.getHouseKinds())){
            sb.append(&quot; INNER JOIN ( &quot;);
            sb.append(&quot; SELECT &quot;);
            sb.append(&quot; ph.projectId &quot;);
            sb.append(&quot; FROM &quot;);
            sb.append(&quot; t_projecthouses ph &quot;);
            sb.append(&quot; WHERE &quot;);
            sb.append(&quot; 1 = 1 &quot;);
            sb.append(&quot; AND ( &quot;);
            String[] kinds = this.stringToArray(param.getHouseKinds());
            for (int i = 0; i &lt; kinds.length; i++) {
                if(i == 0){
                    sb.append(&quot; ph.houseKind = '&quot; + kinds[i] + &quot;' &quot;);
                }else{
                    sb.append(&quot; OR  ph.houseKind = '&quot; + kinds[i] + &quot;' &quot;);
                }
            }
            sb.append(&quot; ) &quot;);
            sb.append(&quot; ) hk ON p5.projectId = hk.projectId &quot;);
            sb.append(&quot; GROUP BY p5.projectId &quot;);
        }

    }

    /**
     * 拼接Hql的p5段 -- 房源类型过滤
     * @param param
     * @param user
     * @param sb
     */
    private void jointHqlTheP6(ShopSearchParam param, User user, StringBuilder sb){
        /**
         * SELECT
                p6.projectId
            FROM
                (
                    {p5}//拼接p5段
                ) p6
            INNER JOIN (
                SELECT
                    applyForPerson
                FROM
                    t_applychart
                WHERE
                    applyByPerson = '860635'
                AND applyStatus = 2
            ) ap ON p6.projectId = ap.applyForPerson
         */
        sb.append(&quot; SELECT &quot;);
        sb.append(&quot; p6.projectId &quot;);
        sb.append(&quot; FROM &quot;);
        sb.append(&quot; ( &quot;);
        this.jointHqlTheP5(param, user, sb);
        sb.append(&quot; ) p6 &quot;);

        if(param.getInviteStatus() != null){
            sb.append(&quot; INNER JOIN ( &quot;);
            sb.append(&quot; SELECT &quot;);
            sb.append(&quot; applyForPerson &quot;);
            sb.append(&quot; FROM &quot;);
            sb.append(&quot; t_applychart &quot;);
            sb.append(&quot; WHERE &quot;);
            sb.append(&quot; applyByPerson = '&quot; + user.getParentId() + &quot;' &quot;);
            sb.append(&quot; AND applyStatus = &quot; + param.getInviteStatus());
            sb.append(&quot; ) ap ON p6.projectId = ap.applyForPerson &quot;);

        }

    }

    /**
     * 拼接Hql的PP段 -- 查看带看业务定义中的佣金
     * @param param
     * @param user
     * @param sb
     */
    private void jointHqlThePP(ShopSearchParam param, User user, StringBuilder sb){
        /**
         * SELECT
                pp.projectId,
                g.fenxiaoMoney
            FROM
                (
                    {p6}//拼接p6段
                ) pp
            LEFT JOIN t_projectguide g ON pp.projectId = g.projectId
         */

        sb.append(&quot; SELECT &quot;);
        sb.append(&quot; pp.projectId, &quot;);
        sb.append(&quot; g.fenxiaoMoney &quot;);
        sb.append(&quot; FROM &quot;);
        sb.append(&quot; ( &quot;);

        this.jointHqlTheP6(param, user, sb);

        sb.append(&quot; ) pp &quot;);
        sb.append(&quot; LEFT JOIN t_projectguide g ON pp.projectId = g.projectId &quot;);

    }


    /**
     * 拼接Hql的P7段
     * @param param
     * @param user
     * @param sb
     */
    private void jointHqlTheP7(ShopSearchParam param, User user, StringBuilder sb){
        /**
         * SELECT
                p7.projectId,
                p7.fenxiaoMoney
            FROM
                (
                    {pp}//拼接pp段
                ) p7
         */

        sb.append(&quot; SELECT &quot;);
        sb.append(&quot; p7.projectId, &quot;);
        sb.append(&quot; p7.fenxiaoMoney &quot;);
        sb.append(&quot; FROM &quot;);
        sb.append(&quot; ( &quot;);

        this.jointHqlThePP(param, user, sb);

        sb.append(&quot; ) p7 &quot;);
    }


    /**
     * 拼接Hql的P8段 -- 项目的合作门店数量
     * @param param
     * @param user
     * @param sb
     */
    private void jointHqlTheP8(ShopSearchParam param, User user, StringBuilder sb){
        /**
         * SELECT
            p8.projectId,
            p8.fenxiaoMoney,
            count(ic.inviteByPerson) shopCount
        FROM
        (
            {p7} //拼接P7段
        ) p8

        LEFT JOIN t_invitechart ic ON p8.projectId = ic.inviteByPerson
        GROUP BY
            p8.projectId
         */
        sb.append(&quot; SELECT &quot;);
        sb.append(&quot; p8.projectId, &quot;);
        sb.append(&quot; p8.fenxiaoMoney, &quot;);
        sb.append(&quot; count(ic.inviteByPerson) shopCount &quot;);
        sb.append(&quot; FROM &quot;);
        sb.append(&quot; ( &quot;);

        this.jointHqlTheP7(param, user, sb);

        sb.append(&quot; ) p8 &quot;);
        sb.append(&quot; LEFT JOIN (SELECT inviteByPerson FROM t_invitechart WHERE inviteStatus = 2) ic ON p8.projectId = ic.inviteByPerson &quot;);
        sb.append(&quot; GROUP BY p8.projectId &quot;);
    }

    /**
     * 拼接Hql的P9段 -- 个人是否收藏
     * @param param
     * @param user
     * @param sb
     */
    private void jointHqlTheP9(ShopSearchParam param, User user, StringBuilder sb, Page page){

        /**
         * SELECT
             *
            FROM
                (
                    {p8}//拼接p8段
                ) p9
            LEFT JOIN (
                SELECT
                    beCollectId
                FROM
                    t_newcollectrecord
                WHERE
                    userId = '4e0b0089-410a-497e-8056-6190e2a183d4'
            ) nc ON p9.projectId = nc.beCollectId
            GROUP BY
                p9.projectId
            ORDER BY
                shopCount DESC
            LIMIT 0,
             10
         */

        sb.append(&quot; SELECT &quot;);
        sb.append(&quot; p9.projectId, p9.fenxiaoMoney, p9.shopCount &quot;);
        sb.append(&quot; FROM &quot;);
        sb.append(&quot; ( &quot;);

        this.jointHqlTheP8(param, user, sb);

        sb.append(&quot; ) p9 &quot;);
        if(param.getIsClikeLike() != null){
            sb.append(&quot; LEFT JOIN ( &quot;);
            sb.append(&quot; SELECT &quot;);
            sb.append(&quot; beCollectId &quot;);
            sb.append(&quot; FROM &quot;);
            sb.append(&quot; t_newcollectrecord &quot;);
            sb.append(&quot; WHERE &quot;);
            sb.append(&quot; userId = '&quot; + user.getUserId() + &quot;' &quot;);
            sb.append(&quot; ) nc ON p9.projectId &quot;);
            if(param.getIsClikeLike() == 1){//收藏
                sb.append(&quot; = &quot;);
            }else{//未收藏
                sb.append(&quot; != &quot;);
            }
            sb.append(&quot; nc.beCollectId &quot;);

            sb.append(&quot; GROUP BY &quot;);
            sb.append(&quot; p9.projectId &quot;);

        }

        if(!isEmpty(param.getOrderType()) &amp;&amp; param.getOrder() != null){

            sb.append(&quot; ORDER BY &quot;);
            if(param.getOrderType().equals(ShopSearchConstant.ORDER_TYPE_SHOP_COUNT)){//合作门店数量
                sb.append(&quot; p9.shopCount &quot;);
            }else if(param.getOrderType().equals(ShopSearchConstant.ORDER_TYPE_MONEY)){//及时结款率  -  暂无
                sb.append(&quot; p9.shopCount &quot;);//暂无，暂时用这个替代
            }else if(param.getOrderType().equals(ShopSearchConstant.ORDER_TYPE_COMMISSION)){//佣金高低
                sb.append(&quot; p9.fenxiaoMoney &quot;);
            }
            sb.append(param.getOrderType());
            if(param.getOrder() == 0){
                sb.append(&quot; DESC &quot;);
            }else{
                sb.append(&quot; ASC &quot;);
            }
        }

        if(page != null){
            sb.append(&quot; LIMIT &quot; + page.getStart() + &quot;,&quot; + page.getLimit());
        }


    }
</code></pre>
<h3>Service 层</h3>
<pre><code class="language-java">//这个方法是将反射之后得到的字段类型和字段名称进行拆分
private void invokeDtoToFieldsToArray(Field[] fields, String[] colums, String[] types){
        for (int i = 0; i &lt; fields.length; i++) {
            types[i] = fields[i].getType().toString().replace(&quot;class java.lang.&quot;, &quot;&quot;);
            colums[i] = fields[i].getName();
        }
    }
</code></pre>
<p><strong>下面的方法就是整个Service中的核心方法了，将自定义sql交给hibernate进行处理，并且使用自定义的dto对象进行封装</strong></p>
<pre><code class="language-java">//这个方法就是将sql进行查询
@Override
    public void findProjectListByShopSearchParam(ShopSearchParam shopSearchParam, Page page, User user) {
        StringBuilder sb = new StringBuilder();

        // 利用反射获取Project组装类的所有的字段和类型
        Field[] fields = ProjectMapListDTO.class.getDeclaredFields();
        String[] colums = new String[fields.length];
        String[] types = new String[fields.length];
        this.invokeDtoToFieldsToArray(fields, colums, types);
        this.jointHqlTheP9(shopSearchParam, user, sb, page);
        //返回的结果
        List&lt;ProjectMapTotalDTO&gt; rsList = new LinkedList&lt;&gt;();
        //当前用户所有收藏的项目
        List&lt;NewCollectRecord&gt; collList =  this.findNewCollectRecordByUserId(user.getUserId(), ShopSearchConstant.COLLECT_TYPE_PROJECT,null);
        //当前门店所有的申请
        List&lt;ApplyChart&gt; appList = this.findApplyChartsByShopId(user.getParentId(), null);
        //---------重要---------这个就是关键方法
        List&lt;ProjectMapListDTO&gt; list = baseDao.queryDTOBySql(sb.toString(), ProjectMapListDTO.class, colums, types);

        //这里是工作需要，将查询出来的结果进行再次封装--看需要吧
        //需要进行判断是否收藏和申请状态的判断
        for (ProjectMapListDTO pd : list) {

            ProjectMapTotalDTO ptd = new ProjectMapTotalDTO();
            Project project = (Project) baseDao.loadById(Project.class, pd.getProjectId());
            ptd.setProject(project);
            ptd.setFenxiaoMoney(pd.getFenxiaoMoney());
            ptd.setShopCount(pd.getShopCount());
            //判断是否已经被收藏
            boolean flag = false;
            for(NewCollectRecord nr : collList){
                if(nr.getBeCollectId().equals(pd.getProjectId())){
                    flag = true;
                }
            }

            //查看合作关系
            for(ApplyChart ac : appList){
                if(pd.getProjectId().equals(ac.getApplyForPerson())){
                    ptd.setApplyStatus(ac.getApplyStatus());
                }
            }

            ptd.setIsLike(flag ? 1 : 0);
            rsList.add(ptd);
        }
        page.setRoot(rsList);

        List&lt;ProjectMapTotalDTO&gt; lz = this.findProjectListForMapNew(shopSearchParam, user);
        page.setTotal(lz.size());

    }
</code></pre>
<p>看看DTO对象</p>
<pre><code class="language-java">package com.sc.tradmaster.service.shop.impl.dto;

public class ProjectMapListDTO {

    private String projectId;
    private Double fenxiaoMoney;
    private Integer shopCount;

    //省略set和get方法


}
</code></pre>
<h4>DAO核心方法</h4>
<pre><code class="language-java">public class BaseDaoImpl extends HibernateDaoSupport implements BaseDao{

    @Resource
    public void mySessionFactory(SessionFactory sf){
        super.setSessionFactory(sf);
    }

/**
     * 执行sql组装DTO对象集合
     * @param sql
     * @param clazz
     * @return
     */
    public List queryDTOBySql(String sql,Class clazz,String[] colums,String[] types) {    
        Session session = super.getSessionFactory().getCurrentSession();
        SQLQuery query = session.createSQLQuery(sql);
        if(colums!=null &amp;&amp; types!=null &amp;&amp; colums.length==types.length){
            for(int i=0;i&lt;colums.length;i++){
                if(types[i].equals(&quot;Integer&quot;)){
                    query.addScalar(colums[i],StandardBasicTypes.INTEGER);
                }else if(types[i].equals(&quot;String&quot;)){
                    query.addScalar(colums[i],StandardBasicTypes.STRING);
                }else if(types[i].equals(&quot;Double&quot;)){
                    query.addScalar(colums[i],StandardBasicTypes.DOUBLE);
                }else if(types[i].equals(&quot;Long&quot;)){
                    query.addScalar(colums[i],StandardBasicTypes.LONG);
                }

            }
        }
        List&lt;Object[]&gt; list = query.setResultTransformer(Transformers.aliasToBean(clazz)).list();
        return list;
    }
   }
</code></pre>
<blockquote>
<p>结语：由于是在工作中用到的代码段，所以显得有些复杂化了，以后有时间的话，使用通俗易懂的方法讲解出来，先留个坑，如果大家遇到这种使用场景无法解决的话，欢迎打扰：1085143002@qq.com</p>
</blockquote>

            </div>


        </article>


        <!-- Comments -->
        <html lang="en">
<body>

<div class="comment-allow">
    <div id="comments-content">
        <div id="41" class="comments-pan">

            <h3>
                0
                Comments
            </h3>

            <ul class="comments-reply">
                


            </ul>
            <div class="commentys-form">

                <h4>Leave a comment</h4>


                <div class="row">

                    <form  id="comment-form" class="comment-form" role="form"
                          onsubmit="return TaleComment.subComment();">

                        <input type="hidden" name="coid" id="coid"/>
                        <input type="hidden" name="cid" id="cid" value="41"/>
                        <input type="hidden" name="_csrf_token" value="N6hFlul6F05lXhqR--34F2"/>
                        <div class="col-xs-12 col-sm-4 col-md-4">

                            <input type="text" name="author" maxlength="12" id="author"
                                   placeholder="姓名 (*)"
                            />

                        </div>

                        <div class="col-xs-12 col-sm-4 col-md-4">

                            <input type="email" name="mail" id="mail"
                                   placeholder="邮箱 (*)"
                            />

                        </div>

                        <div class="col-xs-12 col-sm-4 col-md-4">

                            <input type="url" name="url" id="url"
                                   placeholder="网址 (http://)"
                            />

                        </div>

                        <div class="clearfix"></div>

                        <div class="col-xs-12 col-sm-12 col-md-12">

                                <textarea name="text" id="textarea" placeholder="以上信息可以为空,评论不能为空哦!"
                                          required="required" minlength="5"
                                          maxlength="2000"></textarea>
                        </div>

                        <div class="text-center">

                            <input type="submit" value="Post Comment" id="misubmit"/>

                        </div>


                    </form>

                </div>


            </div>
        </div>
    </div>
</div>
</body>
</html>


    </div>


</main>

<!-- main -->

<!-- footer -->

<html lang="en">
<footer role="footer">

    <!-- logo -->

    <h1> <a href="../../index.html" title="avana LLC"><img src="http://img.winterchen.com/BF6AC5E5-C8D7-4841-B3ED-9D898586D5FF-9703-0000073B1BF8A7F8_tmp.PNG" style="width: 66px;" title="Luis" alt="Luis"/></a> </h1>


    <!-- logo -->

    <!-- nav -->

    <nav role="footer-nav">
        <ul>
            <li><a href="../../index.html" title="Work">Work</a></li>
            <li><a href="../../about.html" title="About">About</a></li>
            <li><a href="../index.html" title="Blog">Blog</a></li>
        </ul>
    </nav>

    <!-- nav -->

    <ul role="social-icons">
        
            
                
                    
                    
                    
                        <li><a class="icon resume" target="blank" href="https://resume.winterchen.com/"></a></li>
                    
                    
                    
                    
                    
                
            
        
            
                
                    
                    
                    
                    
                    
                        <li><a class="icon zhihu" target="blank" href="https://www.zhihu.com/people/Winter_chen"></a></li>
                    
                    
                    
                
            
        
            
                
                    
                    
                    
                    
                    
                    
                        <li><a class="icon github" target="blank" href="https://github.com/WinterChenS"></a></li>
                    
                    
                
            
        
            
        
            
                
                    
                        <li><a class="icon csdn" target="blank" href="https://blog.csdn.net/Winter_chen001"></a></li>
                    
                    
                    
                    
                    
                    
                    
                
            
        
            
        
            
                
                    
                    
                        <li><a class="icon jianshu" target="blank" href="https://www.jianshu.com/u/a6fa02ee712b"></a></li>
                    
                    
                    
                    
                    
                    
                
            
        
    </ul>
    <p class="copy-right">&copy; 2018 Luis</p>
    <a class="copy-right" href="http://www.miitbeian.gov.cn/">浙ICP备17056942号-2</a>
</footer>

<!-- footer -->

<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->

<script src="../../site/js/jquery.min.js" type="text/javascript"></script>

<!-- custom -->

<script src="../../site/js/nav.js" type="text/javascript"></script>
<script src="../../site/js/custom.js" type="text/javascript"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->

<script src="../../site/js/bootstrap.min.js" type="text/javascript"></script>
<script src="../../site/js/effects/masonry.pkgd.min.js"  type="text/javascript"></script>
<script src="../../site/js/effects/imagesloaded.js"  type="text/javascript"></script>
<script src="../../site/js/effects/classie.js"  type="text/javascript"></script>
<script src="../../site/js/effects/AnimOnScroll.js"  type="text/javascript"></script>
<script src="../../site/js/effects/modernizr.custom.js"></script>
<script src="https://cdn.bootcss.com/headroom/0.9.1/headroom.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.9.0/highlight.min.js"></script>
<script src="https://cdn.bootcss.com/instantclick/3.0.1/instantclick.min.js"></script>

<!-- jquery.countdown -->

<script src="../../site/js/html5shiv.js" type="text/javascript"></script>
<script data-no-instant="">
    /*<![CDATA[*/
    InstantClick.on('change', function (isInitialLoad) {
        var blocks = document.querySelectorAll('pre code');
        for (var i = 0; i < blocks.length; i++) {
            hljs.highlightBlock(blocks[i]);
        }
        if (isInitialLoad === false) {
            if (typeof ga !== 'undefined') ga('send', 'pageview', location.pathname + location.search);
        }
    });
    InstantClick.init('mousedown');
    /*]]>*/
</script>
<!-- 百度收录自动推送 -->
<script>
    (function(){
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        }
        else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();

    function linkFirend(link) {
        window.location.href=link;
    }
</script>
</html>

</body>
<html lang="en">
<body>
<script type="text/javascript">
    /*<![CDATA[*/
    (function () {
        window.TaleComment = {
            dom: function (id) {
                return document.getElementById(id);
            },
            create: function (tag, attr) {
                var el = document.createElement(tag);
                for (var key in attr) {
                    el.setAttribute(key, attr[key]);
                }
                return el;
            },
            reply: function (coid) {
                $('#comment-form input[name=coid]').val(coid);
                $("html,body").animate({scrollTop: $('div.comment-container').offset().top}, 500);
                $('#comment-form #textarea').focus();
            },
            subComment: function () {
                $.ajax({
                    type: 'post',
                    url: '/blog/comment',
                    data: $('#comment-form').serialize(),
                    async: false,
                    dataType: 'json',
                    success: function (result) {
                        $('#comment-form input[name=coid]').val('');
                        if (result && result.code == 'success') {
                            alert("评论已提交至后台审核!");
                            window.location.reload();
                        } else {
                            if (result.msg) {
                                alert(result.msg);
                            }
                        }
                    }
                });
                return false;
            }
        };
    })();
    function getCommentCookie(name) {
        var arr, reg = new RegExp("(^| )" + name + "=([^;]*)(;|$)");
        if (arr = document.cookie.match(reg))
            return unescape(decodeURI(arr[2]));
        else
            return null;
    }
    function addCommentInputValue() {
        document.getElementById('author').value = getCommentCookie('tale_remember_author');
        document.getElementById('mail').value = getCommentCookie('tale_remember_mail');
        document.getElementById('url').value = getCommentCookie('tale_remember_url');
    }
    addCommentInputValue();
    /*]]>*/
</script>
</body>
</html>
</html>